<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GD Room</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <header class="topbar">
    <a href="/">‚Üê Home</a>
    <div id="info"></div>
  </header>

  <main class="room">

    <section class="controls">
      <div id="roleBadge"></div>

      <button id="toggleVideo">Toggle Video</button>
      <button id="toggleAudio">Toggle Mic</button>

      <button id="startRecord" style="display:none">Start Recording (Manager)</button>
      <button id="stopRecord" style="display:none" disabled>Stop & Upload</button>

      <div id="shareLink" style="margin-top:10px"></div>
    </section>

    <section id="videos" class="videos"></section>

  </main>

  <script>
    window.BACKEND_URL = '';

    async function loadSocketIoAndStart() {

      // Load config
      try {
        const cfg = await fetch('config.json').then(r => r.json());
        window.BACKEND_URL = cfg.BACKEND_URL || '';
      } catch (e) {}

      // Load socket.io dynamically
      const socketPath = window.BACKEND_URL
        ? window.BACKEND_URL + '/socket.io/socket.io.js'
        : '/socket.io/socket.io.js';

      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = socketPath;
        s.onload = resolve;
        s.onerror = resolve; // fallback silently
        document.head.appendChild(s);
      });

      // Get URL params
      const params = new URLSearchParams(location.search);
      const room = params.get('room') || 'ROOM';
      const role = params.get('role') || 'participant';
      const name = params.get('name') || role;

      document.getElementById('info').innerText = `Room: ${room}`;
      document.getElementById('roleBadge').innerText = `Role: ${role}`;

      const socket = (typeof io !== 'undefined')
        ? (window.BACKEND_URL ? io(window.BACKEND_URL) : io())
        : null;

      // Get camera + mic
      const localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });

      const videos = document.getElementById('videos');

      function addVideoEl(id, stream, label) {
        let el = document.querySelector(`[data-id="${id}"]`);

        if (!el) {
          el = document.createElement('div');
          el.className = 'tile';
          el.setAttribute('data-id', id);

          const v = document.createElement('video');
          v.autoplay = true;
          v.playsInline = true;
          v.muted = (id === 'me');
          v.srcObject = stream;

          const caption = document.createElement('div');
          caption.className = 'caption';
          caption.innerText = label || id;

          el.appendChild(v);
          el.appendChild(caption);
          videos.appendChild(el);
        } else {
          el.querySelector('video').srcObject = stream;
        }
      }

      // Show local video
      addVideoEl('me', localStream, `${name} (You)`);

      const pcs = {};
      const localTracks = localStream.getTracks();

      socket && socket.emit('join-room', { room, name, role });

      socket && socket.on('joined', async ({ peers }) => {
        for (const peerId of peers) {
          await createOffer(peerId);
        }
      });

      socket && socket.on('peer-joined', async ({ id }) => {
        await createOffer(id);
      });

      socket && socket.on('peer-left', ({ id }) => {
        if (pcs[id]) {
          pcs[id].close();
          delete pcs[id];
          const el = document.querySelector(`[data-id="${id}"]`);
          if (el) el.remove();
        }
      });

      socket && socket.on('signal', async ({ from, data }) => {
        let pc = pcs[from];

        if (data.sdp) {
          if (data.sdp.type === 'offer') {

            pc = new RTCPeerConnection();
            localTracks.forEach(t => pc.addTrack(t, localStream));

            pc.onicecandidate = e => {
              if (e.candidate) {
                socket.emit('signal', { to: from, data: { ice: e.candidate } });
              }
            };

            pc.ontrack = e => {
              addVideoEl(from, e.streams[0], `Peer ${from}`);
            };

            await pc.setRemoteDescription(data.sdp);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            socket.emit('signal', { to: from, data: { sdp: pc.localDescription } });

            pcs[from] = pc;

          } else if (data.sdp.type === 'answer') {
            if (pc) await pc.setRemoteDescription(data.sdp);
          }
        }

        if (data.ice && pc) {
          await pc.addIceCandidate(data.ice).catch(() => {});
        }
      });

      async function createOffer(peerId) {
        const pc = new RTCPeerConnection();

        localTracks.forEach(t => pc.addTrack(t, localStream));

        pc.onicecandidate = e => {
          if (e.candidate) {
            socket.emit('signal', { to: peerId, data: { ice: e.candidate } });
          }
        };

        pc.ontrack = e => {
          addVideoEl(peerId, e.streams[0], `Peer ${peerId}`);
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.emit('signal', { to: peerId, data: { sdp: pc.localDescription } });

        pcs[peerId] = pc;
      }

      // üî¥ Recording (Manager Only)

      const isManager = role === 'manager';
      const managerStream = new MediaStream();
      localTracks.forEach(t => managerStream.addTrack(t));

      const startBtn = document.getElementById('startRecord');
      const stopBtn = document.getElementById('stopRecord');
      const shareEl = document.getElementById('shareLink');

      let recorder;

      if (isManager) {
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'inline-block';
      }

      startBtn.addEventListener('click', () => {

        recorder = new MediaRecorder(managerStream);
        const chunks = [];

        recorder.ondataavailable = e => chunks.push(e.data);

        recorder.onstop = async () => {

          const blob = new Blob(chunks, { type: 'video/webm' });

          const fd = new FormData();
          fd.append('recording', blob, `gd-${room}.webm`);
          fd.append('room', room);

          const uploadUrl = window.BACKEND_URL
            ? `${window.BACKEND_URL}/upload`
            : '/upload';

          const res = await fetch(uploadUrl, {
            method: 'POST',
            body: fd
          });

          const json = await res.json();
          const link = json.url;

          shareEl.innerHTML =
            `Recording uploaded: <a href="${link}" target="_blank">${link}</a>`;

        };

        recorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
      });

      stopBtn.addEventListener('click', () => {
        if (recorder && recorder.state !== 'inactive') {
          recorder.stop();
        }
        startBtn.disabled = false;
        stopBtn.disabled = true;
      });

      // üé• Toggle Video
      document.getElementById('toggleVideo')
        .addEventListener('click', () => {
          localStream.getVideoTracks().forEach(t => {
            t.enabled = !t.enabled;
          });
        });

      // üé§ Toggle Audio
      document.getElementById('toggleAudio')
        .addEventListener('click', () => {
          localStream.getAudioTracks().forEach(t => {
            t.enabled = !t.enabled;
          });
        });

    }

    loadSocketIoAndStart();

  </script>

</body>
</html>